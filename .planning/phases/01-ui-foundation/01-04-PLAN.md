---
phase: 01-ui-foundation
plan: 04
type: execute
wave: 2
depends_on:
  - "01-02"
files_modified:
  - FinanceDashboard/inline_dropdown.py
  - FinanceDashboard/styles.py
autonomous: true

must_haves:
  truths:
    - "User can click anywhere in a dropdown cell to open selection"
    - "Dropdown has search box that filters options as user types"
    - "User can dismiss dropdown by clicking outside or pressing Escape"
    - "User can navigate options with arrow keys and select with Enter"
    - "Options are grouped under section headers"
    - "Clear option (X or None) is always available"
    - "Selection saves immediately without confirmation dialog"
  artifacts:
    - path: "FinanceDashboard/inline_dropdown.py"
      provides: "InlineDropdown component class"
      exports: ["InlineDropdown"]
      min_lines: 80
    - path: "FinanceDashboard/styles.py"
      provides: "Dropdown styling CSS"
      contains: "dropdown"
  key_links:
    - from: "FinanceDashboard/inline_dropdown.py"
      to: "streamlit"
      via: "st.selectbox or custom component"
      pattern: "import streamlit as st"
---

<objective>
Create a reusable inline dropdown component for cell-level editing with search, keyboard navigation, and grouped options.

Purpose: The user wants inline interactions (dropdowns in cells, not floating panels). This component enables selecting categories, transactions, or other values directly within table cells, with immediate save on selection.

Output: InlineDropdown class that provides searchable, keyboard-navigable dropdown for inline editing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-ui-foundation/01-CONTEXT.md

# Design system
@FinanceDashboard/styles.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineDropdown component</name>
  <files>FinanceDashboard/inline_dropdown.py</files>
  <action>
Create a new file `inline_dropdown.py` with an InlineDropdown class:

```python
import streamlit as st
from typing import List, Dict, Optional, Callable

class InlineDropdown:
    """Inline dropdown for cell-level selection.

    Features:
    - Click anywhere in cell to open
    - Search box filters options
    - Keyboard navigation (arrows, Enter, Escape)
    - Grouped options under section headers
    - Clear option (None)
    - Immediate save on selection

    Note: Streamlit limitations mean we use st.selectbox with popover
    for a similar experience. Full AG Grid cell editors are complex
    and may require custom JavaScript components.
    """

    def __init__(
        self,
        key: str,
        options: List[str],
        groups: Dict[str, List[str]] = None,
        current_value: str = None,
        placeholder: str = "Select...",
        allow_clear: bool = True,
        on_change: Callable = None,
        suggestions: List[str] = None
    ):
        """
        Args:
            key: Unique key for this dropdown
            options: Flat list of all options
            groups: Optional dict of group_name -> [options] for grouping
            current_value: Currently selected value
            placeholder: Placeholder text when nothing selected
            allow_clear: Whether to show clear/None option
            on_change: Callback function when selection changes
            suggestions: Smart suggestions to show at top
        """
        self.key = key
        self.options = options
        self.groups = groups
        self.current_value = current_value
        self.placeholder = placeholder
        self.allow_clear = allow_clear
        self.on_change = on_change
        self.suggestions = suggestions or []

    def render(self) -> Optional[str]:
        """Render the dropdown and return selected value."""
        # Build option list with grouping
        display_options = self._build_display_options()

        # Find current index
        current_index = 0
        if self.current_value in display_options:
            current_index = display_options.index(self.current_value)

        # Use st.selectbox with search (Streamlit 1.29+)
        # Note: st.selectbox has built-in search when there are many options
        selected = st.selectbox(
            label=self.placeholder,
            options=display_options,
            index=current_index,
            key=self.key,
            label_visibility="collapsed",
            on_change=self._handle_change if self.on_change else None
        )

        # Handle clear option
        if selected == "(Clear)":
            return None

        return selected

    def _build_display_options(self) -> List[str]:
        """Build ordered list with optional grouping."""
        result = []

        # Clear option first
        if self.allow_clear:
            result.append("(Clear)")

        # Suggestions section
        if self.suggestions:
            # Mark suggestions (could use emoji or prefix)
            for s in self.suggestions:
                if s not in result:
                    result.append(s)

        # Grouped options
        if self.groups:
            for group_name, group_options in self.groups.items():
                # Add group header (using a disabled option pattern)
                # Note: Streamlit selectbox doesn't support disabled options
                # so we use a visual separator
                result.append(f"--- {group_name} ---")
                for opt in group_options:
                    if opt not in result:
                        result.append(opt)
        else:
            # Flat list
            for opt in self.options:
                if opt not in result:
                    result.append(opt)

        return result

    def _handle_change(self):
        """Trigger callback on change."""
        if self.on_change:
            self.on_change()


def create_category_dropdown(
    key: str,
    categories: Dict[str, dict],
    current: str = None,
    on_change: Callable = None
) -> Optional[str]:
    """Helper to create a category dropdown with type grouping.

    Args:
        key: Unique widget key
        categories: Budget dict from CategoryEngine (cat -> {type, limit, ...})
        current: Current category value
        on_change: Callback on selection
    """
    # Group categories by type
    groups = {}
    for cat, meta in categories.items():
        cat_type = meta.get('type', 'Other')
        if cat_type not in groups:
            groups[cat_type] = []
        groups[cat_type].append(cat)

    dropdown = InlineDropdown(
        key=key,
        options=list(categories.keys()),
        groups=groups,
        current_value=current,
        placeholder="Select category",
        on_change=on_change
    )
    return dropdown.render()
```

Note: Full inline cell editing in AG Grid requires custom JavaScript cell editors.
This component provides a Streamlit-native approach for simpler use cases.
For AG Grid inline editing, use the editable column configuration in VaultTable.
  </action>
  <verify>
```python
from inline_dropdown import InlineDropdown, create_category_dropdown
```
Import test from FinanceDashboard directory.
  </verify>
  <done>
InlineDropdown class exists with search, grouping, clear option, and callback support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dropdown styling to design system</name>
  <files>FinanceDashboard/styles.py</files>
  <action>
Add CSS styling for dropdown components in styles.py:

```css
/* Inline Dropdown Styling */
.stSelectbox {
    /* Clean container */
}

.stSelectbox > div > div {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
}

.stSelectbox > div > div:hover {
    border-color: var(--accent-color);
}

.stSelectbox > div > div:focus-within {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
}

/* Dropdown menu styling */
[data-baseweb="select"] [role="listbox"] {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    max-height: 300px;
    overflow-y: auto;
}

/* Option styling */
[data-baseweb="select"] [role="option"] {
    padding: var(--spacing-sm) var(--spacing-md);
    cursor: pointer;
}

[data-baseweb="select"] [role="option"]:hover {
    background-color: var(--neutral-bg);
}

/* Group header styling (for --- Group --- pattern) */
[data-baseweb="select"] [role="option"]:has-text("---") {
    color: var(--text-secondary);
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    pointer-events: none;
    background-color: transparent;
}

/* Clear option styling */
[data-baseweb="select"] [role="option"]:first-child {
    color: var(--color-neutral);
    font-style: italic;
}
```

Note: Some CSS selectors may need adjustment based on actual Streamlit DOM structure.
Test visually and adjust as needed.
  </action>
  <verify>
Run dashboard and inspect dropdown styling:
- Clean border and rounded corners
- Hover state shows accent color
- Menu has shadow
- Options have good padding
  </verify>
  <done>
Dropdowns have polished visual styling consistent with design system.
  </done>
</task>

</tasks>

<verification>
1. InlineDropdown class in inline_dropdown.py
2. create_category_dropdown helper for common use case
3. Dropdown styling in styles.py
4. Dropdowns render cleanly in Streamlit
5. Search filters options
6. Clear option available
</verification>

<success_criteria>
- InlineDropdown provides reusable dropdown with search and grouping
- Visual styling matches design system
- Component ready for integration with tables in future phases
</success_criteria>

<output>
After completion, create `.planning/phases/01-ui-foundation/01-04-SUMMARY.md`
</output>
