---
phase: 01-ui-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - FinanceDashboard/table_component.py
  - FinanceDashboard/components.py
autonomous: true

must_haves:
  truths:
    - "All tables use a single standardized component class"
    - "Tables have sortable columns (click header to toggle asc/desc)"
    - "Tables have global search box filtering all rows"
    - "Tables have multi-select with checkbox column"
    - "Tables show subtle row highlight on hover"
    - "Tables show color-coded amounts with sign prefix"
    - "Empty tables show action prompt message"
  artifacts:
    - path: "FinanceDashboard/table_component.py"
      provides: "VaultTable class with consistent behavior"
      exports: ["VaultTable"]
      min_lines: 100
    - path: "FinanceDashboard/components.py"
      provides: "Updated render functions using VaultTable"
      contains: "VaultTable"
  key_links:
    - from: "FinanceDashboard/components.py"
      to: "FinanceDashboard/table_component.py"
      via: "import VaultTable"
      pattern: "from table_component import VaultTable"
    - from: "FinanceDashboard/table_component.py"
      to: "st_aggrid"
      via: "AgGrid wrapper"
      pattern: "from st_aggrid import"
---

<objective>
Create a standardized OOP table component that wraps AG Grid with consistent behavior across all dashboard tables.

Purpose: The current codebase has multiple render_*_grid functions with duplicated AG Grid configuration. A single VaultTable class ensures all tables look and behave identically, making the UI predictable and easier to maintain.

Output: VaultTable class that encapsulates all table behavior (sorting, filtering, selection, styling) and updated components using it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-ui-foundation/01-CONTEXT.md

# Current table implementations
@FinanceDashboard/components.py

# Design system
@FinanceDashboard/styles.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VaultTable class</name>
  <files>FinanceDashboard/table_component.py</files>
  <action>
Create a new file `table_component.py` with a VaultTable class:

```python
from st_aggrid import AgGrid, GridOptionsBuilder, GridUpdateMode, JsCode
import streamlit as st
import pandas as pd

class VaultTable:
    """Standardized table component for Vault dashboard.

    Features:
    - Sortable columns (click header)
    - Global search box
    - Multi-select with checkboxes
    - Fixed column widths with visibility toggle
    - Row hover highlight
    - Color-coded amounts
    - Empty state handling
    """

    def __init__(
        self,
        df: pd.DataFrame,
        key: str,
        columns_config: dict = None,
        height: int = 400,
        show_search: bool = True,
        show_checkbox: bool = True,
        show_actions: bool = True,
        empty_message: str = "No data yet â€” import transactions to get started"
    ):
        self.df = df
        self.key = key
        self.columns_config = columns_config or {}
        self.height = height
        self.show_search = show_search
        self.show_checkbox = show_checkbox
        self.show_actions = show_actions
        self.empty_message = empty_message

    def render(self):
        """Render the table with all configured behaviors."""
        # Handle empty state
        if self.df.empty:
            st.info(self.empty_message)
            return None

        # Global search box
        search_term = ""
        if self.show_search:
            search_term = st.text_input(
                "Search",
                key=f"{self.key}_search",
                placeholder="Type to filter...",
                label_visibility="collapsed"
            )

        # Filter dataframe if search active
        filtered_df = self._apply_search(self.df, search_term)

        # Build grid options
        gb = self._build_grid_options(filtered_df)

        # Render AgGrid
        grid_response = AgGrid(
            filtered_df,
            gridOptions=gb.build(),
            height=self.height,
            width='100%',
            fit_columns_on_grid_load=True,
            allow_unsafe_jscode=True,
            key=self.key,
            update_mode=GridUpdateMode.SELECTION_CHANGED | GridUpdateMode.VALUE_CHANGED,
            theme='alpine'
        )

        return grid_response

    def _apply_search(self, df, term):
        """Filter all string columns by search term."""
        if not term:
            return df
        mask = df.apply(
            lambda row: row.astype(str).str.contains(term, case=False).any(),
            axis=1
        )
        return df[mask]

    def _build_grid_options(self, df):
        """Configure AG Grid with standard behaviors."""
        gb = GridOptionsBuilder.from_dataframe(df)

        # Enable sorting on all columns
        gb.configure_default_column(sortable=True, resizable=False)

        # Checkbox selection
        if self.show_checkbox:
            gb.configure_selection('multiple', use_checkbox=True)

        # Apply column-specific config
        for col, config in self.columns_config.items():
            if col in df.columns:
                gb.configure_column(col, **config)

        # Amount column styling (if exists)
        if 'amount' in df.columns:
            amount_style = JsCode("""
            function(params) {
                if (params.value > 0) {
                    return {'color': '#16a34a', 'fontWeight': '600'};
                } else if (params.value < 0) {
                    return {'color': '#dc2626', 'fontWeight': '600'};
                }
                return {};
            }
            """)
            amount_format = JsCode("""
            function(params) {
                if (params.value == null) return '';
                const sign = params.value >= 0 ? '+' : '';
                return sign + params.value.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            }
            """)
            gb.configure_column(
                'amount',
                headerName='VALOR',
                cellStyle=amount_style,
                valueFormatter=amount_format,
                type=['numericColumn']
            )

        # Row hover highlight
        gb.configure_grid_options(
            rowStyle={'cursor': 'pointer'},
            getRowStyle=JsCode("""
            function(params) {
                return {};  // Base style, hover handled by CSS
            }
            """)
        )

        # Auto height for small datasets, scroll for large
        if len(df) <= 10:
            gb.configure_grid_options(domLayout='autoHeight')

        return gb
```

Include docstrings explaining usage patterns.
  </action>
  <verify>
```python
# Quick import test
from table_component import VaultTable
```
Run from FinanceDashboard directory to confirm no syntax errors.
  </verify>
  <done>
VaultTable class exists with sorting, search, selection, and amount styling capabilities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate components to use VaultTable</name>
  <files>FinanceDashboard/components.py</files>
  <action>
Update components.py to use VaultTable instead of direct AgGrid calls:

1. Add import at top:
```python
from table_component import VaultTable
```

2. Update `render_recurring_grid`:
```python
def render_recurring_grid(df, key_suffix, title=""):
    if title:
        st.markdown(f"### {title}")

    columns_config = {
        'Due': {'headerName': 'DATA', 'width': 70, 'pinned': 'left'},
        'Item': {'headerName': 'DESCRICAO', 'flex': 2},
        'Expected': {'headerName': 'VALOR', 'editable': True},
        'Status': {
            'headerName': 'STATUS',
            'cellStyle': JsCode("""...""")  # Keep existing status styling
        },
        'Suggested Match': {'headerName': 'TRANSACAO MAPEADA', 'flex': 3},
        # Hide columns
        'Renamed': {'hide': True},
        'Original': {'hide': True},
        'Source': {'hide': True},
        'Actual': {'hide': True},
        '_raw_match': {'hide': True}
    }

    table = VaultTable(
        df=df,
        key=key_suffix,
        columns_config=columns_config,
        empty_message="Nenhum item recorrente."
    )
    return table.render()
```

3. Update `render_cards_grid`:
```python
def render_cards_grid(df, key_suffix):
    # Prepare parcela column
    df = df.copy()
    df['Parcela'] = df['description'].apply(extract_parcela)

    columns_config = {
        'date': {'headerName': 'DATA', 'width': 110, 'pinned': 'left'},
        'account': {'headerName': 'CARTAO', 'width': 150},
        'category': {'headerName': 'CATEGORIA', 'editable': True, 'width': 140},
        'subcategory': {'headerName': 'SUBCATEGORIA', 'editable': True, 'width': 140},
        'description': {'headerName': 'DESCRICAO', 'editable': True, 'flex': 3},
        'Parcela': {'headerName': 'PARCELA', 'width': 100}
    }

    table = VaultTable(
        df=df,
        key=key_suffix,
        columns_config=columns_config,
        height=500,
        empty_message="Sem transacoes de cartao."
    )
    return table.render()
```

4. Update `render_checklist_grid` similarly.

5. Keep any specialized logic (parcela extraction, etc.) but delegate grid rendering to VaultTable.
  </action>
  <verify>
Run `streamlit run FinanceDashboard/dashboard.py` and verify:
- All grids render correctly
- Sorting works (click column headers)
- Search box filters rows
- Amount colors show correctly (green positive, red negative)
- Empty states show appropriate message
  </verify>
  <done>
All table components use VaultTable with consistent behavior across the dashboard.
  </done>
</task>

</tasks>

<verification>
1. VaultTable class exists in table_component.py
2. All render_*_grid functions use VaultTable
3. Tables have working sort (click headers)
4. Tables have working search (type to filter)
5. Amounts show color + sign prefix
6. Empty tables show action prompt
7. No duplicate AG Grid configuration across files
</verification>

<success_criteria>
- Single VaultTable class encapsulates all table behavior
- All dashboard tables use VaultTable
- Consistent look and behavior across all tables
- Table features match CONTEXT.md specification
</success_criteria>

<output>
After completion, create `.planning/phases/01-ui-foundation/01-03-SUMMARY.md`
</output>
